---
title: "Nginx ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¤ã‹ã£ã¦ã¿ã‚‹ã€‚Apac"
emoji: "ðŸ“"
type: "tech"
topics: nginx Apache Apache2.4
published: true
---

# Apache2.4å‘ã‘ã«å†ç·¨é›†ã—ã¾ã—ãŸ
ã€Œmod_rpaf â‡’ mod_remoteipã€ã«

# ã‚„ã£ã¨ Nginx ã‚’è§¦ã£ã¦ã¿ã‚‹
Nginx å‹‰å¼·ç”¨ã«è²·ã£ãŸæœ¬ãŒåŸ‹ã‚‚ã‚Œã¦ã¾ã—ãŸã€‚ãã®ã†ã¡ã¨ãƒ»ãƒ»ãƒ»æ€ã£ã¦ã„ãŸã‚‰ã€‚ã™ã§ã«ï¼’å¹´ãŒçµŒéŽã—ã¨ã£ãŸã€‚

ç¾åœ¨,æˆ‘ãŒå®¶ã®æ§‹æˆã¨ã—ã¦ ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€ã¤ã—ã‹ãªã„ãŸã‚è¤‡æ•°ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ VirtualHost ã§é‹ç”¨ã—ã¦ã‚‹çŠ¶æ³ã€‚Nginx ã«å…¨ã¦ç½®ãæ›ãˆã¦ã‚‚ã„ã„ã®ã ã‘ã©ã“ã“ã¯ Nginx -> Apache ã¨å¤šæ®µã«ã—ã¦ã¿ã‚‹å‹‰å¼·ãŒã¦ã‚‰ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦è¨­å®šã—ã¦ã¿ã‚‹ï¼ˆãã‚‚ãã‚‚ Nginx ãŒè»½å¿«ã§é€Ÿã„ã¨ã„ã†ç†ç”±ã¯[é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é«˜é€Ÿã§é…ä¿¡ã™ã‚‹è¨­è¨ˆæ€æƒ³](http://www.atmarkit.co.jp/ait/articles/1406/17/news013.html)ãªã¨ã“ã‚ã¯ç†è§£ã—ã¦ã„ã‚‹ã¤ã‚‚ã‚Šï¼‰ã€‚

# 
![nginx.png](https://qiita-image-store.s3.amazonaws.com/0/44540/829fcf0a-cb76-4ca9-72b2-5d69c31f5f4b.png)

# ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šãƒãƒªã‚·ãƒ¼
ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œã•ã›ã‚‹ãƒ›ã‚¹ãƒˆã« Nginx ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚ã¾ãŸDNSè¨­å®šæ¸ˆã¿ã§ã§ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå¼•ã‘ã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã€æ—¢å­˜ Apache ã®è¨­å®šã¯å¤‰æ›´ã›ãšãªã©ã‚ã‚‹ã‘ã©åŸºæœ¬çš„ã«ã¯ã€å•é¡ŒãŒã‚ã‚Œã°ã™ãã«æˆ»ã›ã‚‹æ§‹æˆã«ã—ã¦ã¿ã‚‹ã€‚

![nginx2.png](https://qiita-image-store.s3.amazonaws.com/0/44540/d55ee09c-767f-053a-2a10-d02117bbff8d.png)
 

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã¨ã‚Šã‚ãˆãšç‰¹åˆ¥ãªæ©Ÿèƒ½ã‚’ä½¿ã†ç”¨é€”ãŒãªã„ã®ã§ã‚ã‚Œã°ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã€‚å½“ãŸã‚Šå‰ã§ã™ãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç‰ˆã® Nginx ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ©Ÿèƒ½ã—ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã®ã§ã€æ‹¡å¼µã—ãŸã„å ´åˆã¯ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã“ã¨ï¼ˆnginx -V ã§æ©Ÿèƒ½ã‚’ã¿ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼‰ã€‚

> [CentOS6.xã«ã¦nginxã®æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ‰‹é †](http://qiita.com/utano320/items/0c0d9b84a9a28525bcb9)

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« 
/etc/nginx/conf.d ã®ä¸‹ã«é©å½“ãªãƒ•ã‚¡ã‚¤ãƒ«åã§ configãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
server {
    listen 80;
    server_name ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆå;ã€€â† å¤–éƒ¨ã‹ã‚‰å¼•ã‘ã‚‹ã“ã¨

    proxy_set_header    X-Real-IP       $remote_addr;
    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header    Host            $http_host;
    proxy_redirect      off;
    proxy_max_temp_file_size    0;

    location / {
        proxy_pass http://192.168.11.88;
    }
}
```

# Nginxã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’éš ã™
å…¬é–‹ã‚µãƒ¼ãƒã¯è‰²ã€…ã¨æƒ…å ±ã‚’å…¬é–‹ã™ã¹ãã§ã¯ãªã„ã®ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’éš ã—ã¦ãŠãã¾ã™ã€‚

```
http {
  server_tokens off;
  ...
```

# mod_remoteip ã®è¨­å®š
å¾Œè¨˜ã® `mod_rpaf` ã¯ã€Apache 2.4 ã§ä½¿ç”¨ã«ã¯ã‚³ãƒ„ãŒã„ã‚‹ã®ã§ Apache2.2 ã‹ã‚‰æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãªã£ãŸ `mod_remoteip` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

è¨­å®šæ–¹æ³•ã¯ `RemoteIPHeader X-Forwarded-For` ã‚’ `/etc/httpd/conf/httpd.conf` ã®æœ€å¾Œã«ã§ã‚‚æŒ‡å®šã—ã¦ãŠã‘ã°ã‚ˆã„ã€‚

ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°æŒ‡å®š `LogFormat` éƒ¨åˆ†ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã€‚
â€»%a ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹å…ƒIP ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```text
LogFormat "%h ãƒ»ãƒ»ãƒ»ãƒ»
â†“
LogFormat "%a ãƒ»ãƒ»ãƒ»ãƒ»
```

> [mod_remoteip ã‚’ä½¿ã£ã¦ LB é…ä¸‹ã® Apache ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å…ƒ IP ã‚’æ­£ã—ãèªè­˜ã§ãã‚‹](https://blog.yskw.info/articles/256/)

# mod_rpaf ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(Apache2.4éžæŽ¨å¥¨)
ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è»¢é€ã•ã‚ŒãŸæƒ…å ±ã‚’ Apacheå´ã§å—ã‘å–ã‚‹ã¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹(192.168.11.88)ãŒè¨˜éŒ²ã•ã‚Œã¦ã—ã¾ã†ãŸã‚å…·åˆãŒæ‚ªã„ã®ã§ã€Apacheå´ ã« mod_rpaf ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
â‡’ Apache 2.4 ã§ä½¿ç”¨ã™ã‚‹å ´åˆã¡ã‚‡ã£ã¨ã‚³ãƒ„ãŒã„ã‚‹ã®ã§ mod_remoteip ã‚’ä½¿ã†

> [ãƒªãƒ¼ãƒã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã¨mod_rpaf](http://heartbeats.jp/hbblog/2012/03/mod-rpaf.html)
> [nginx+apacheã§ã¡ã‚‡ã£ã´ã‚Šå¿«é©ãªWebã‚µãƒ¼ãƒãƒ¼ã‚’ç›®æŒ‡ã—ã¦ã¿ã‚‹](http://havelog.ayumusato.com/develop/server/e198-nginx-with-apache.html)
> [nginxã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·å…ˆã«ãƒ›ã‚¹ãƒˆåãŒå¼•ãç¶™ãŒã‚Œãªã„](http://blog.fujimuradaisuke.com/post/12622482560/nginx)

# Nginx ã‚’è§¦ã£ã¦ã¿ã¦
Nginx å°‘ã—æ¯›å«Œã„ã—ã¦ãŸæ„Ÿã˜ã‚‚ã‚ã‚‹ã‘ã©è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ç›´æ„Ÿçš„ã§åˆ¤ã‚Šã‚„ã™ã„ã®ã§ã„ã„ã‹ã‚‚ã€‚
æ„å¤–ã¨ç°¡å˜ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã‚‚ã§ãã‚‹ã‚‚ã‚“ã ãªã¨æ€ã£ãŸæ¬¡ç¬¬ã€‚

# Rewrite
Apache ã ã‘ã©æ¯Žå›žå¿˜ã‚Œã‚‹ã®ã§Rewriteã®ãƒªãƒ³ã‚¯ãƒ¡ãƒ¢

> [Apache Rewrite å­¦ç¿’](http://weblabo.oscasierra.net/apache-rewrite-1/)

# å‚è€ƒã‚µã‚¤ãƒˆ
> [nginx ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ã¨ãã® Tips](http://blog.akagi.jp/archives/3883.html)
> [ä»®æƒ³CentOSã®nginx+Apach2ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·](http://sonicnotes.tumblr.com/post/56255167207/centos-nginx-apach2)
> [nginxé€£è¼‰3å›žç›®: nginxã®è¨­å®šã€ãã®1](http://heartbeats.jp/hbblog/2012/02/nginx03.html)
> []()






---
title: "ã„ã¾ã•ã‚‰ fluentdã‚’ã¯ã˜ã‚ã¦ã¿ãŸ Apache + Elasticsearch + Kibana ãªã«ãã‚Œç¾å‘³ã—ã„ã®ï¼Ÿã€ãã®ï¼•"
emoji: "ğŸ“"
type: "tech"
topics: Fluentd CentOS6.5 Elasticsearch kibana3
published: true
---

# ã„ã¾ã•ã‚‰ fluentd ã¯ã˜ã‚ã¦ã¿ã‚‹ï¼•ï¼ˆå®Œçµç·¨ï¼‰
ç´†ä½™æ›²æŠ˜ã—ã¾ã—ãŸãŒã€ã‚„ã£ã¨ã€Œ[ã‚‚ã†ä½•ç•ªç…ã˜ã ï¼Ÿ](http://blog.johtani.info/blog/2013/06/10/fluent-es-kibana/)ã€ãã‚‰ã„åŒã˜ãƒ¬ãƒ™ãƒ«ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã—ãŸã€‚ã„ã‚„ã¯ã‚„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ[bug](http://qiita.com/murachi1208/items/39e3ef65ad859e2d9705)ã‚ã£ãŸãŠã‹ã’ï¼Ÿã§å‹‰å¼·è‰²ã€…ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã‚ˆã†ã‚„ã£ã¨ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã«ãŸã¦ã¾ã—ãŸï½—ã€‚ã§ã€æœ¬é¡Œã€ŒApache + fluentd + Elasticsearch + Kibanaã€ ã¨ã„ã†ã“ã¨ã§ï¼ˆæœ¬å½“ã«ä½•ç•ªç…ã˜ï¼Ÿï¼‰å®Œçµç·¨ã§ã™ã€‚

> [fluentd + Elasticsearch + Kibanaã§ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã‚µãƒ¼ãƒã‚’ä½œã‚‹](http://qiita.com/nagane/items/5b6d3fc1a8706146fb0b)

![apache.png](https://qiita-image-store.s3.amazonaws.com/0/44540/6ca576dc-5299-ae9f-9f3b-348a0c596e12.png)

# File descriptor, Kernel ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š
[vm](http://qiita.com/murachi1208/items/5b429cb7cedf76164e67) ã‚’ï¼’ã¤ç”¨æ„ã—ã¾ã™ã€‚ã“ã‚Œã¯å˜ã«ã‚µãƒ¼ãƒ“ã‚¹å´ã¨è§£æå´ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ†é›¢ã—æ˜ç¢ºã«ã—ãŸã„ã ã‘ï¼ˆè¶£å‘³çš„ãªå•é¡Œï¼‰ãªã®ã§é©å®œèª­ã¿é£›ã°ã—ã¦é ‚ã„ã¦ã‚‚çµæ§‹ã§ã™ã€‚ã§ã‚‚ fluentd ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã‚’çµæ§‹ä½¿ã†ã‚‰ã—ã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1024 ã‚ˆã‚Šå¤§ãã„å€¤ã«ã—ã¦ãŠãã¾ã™ã€‚

```
$ sudo vi /etc/security/limits.conf
root soft nofile 65536
root hard nofile 65536
* soft nofile 65536
* hard nofile 65536

$ ulimit -n ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚’å†èµ·å‹•ï¼‰
```

```
$ sudo vi /etc/sysctl.conf
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.ip_local_port_range = 10240    65535

$ sysctl -w
```

# fluentd ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸ td-agent 0.10.45 ã‚’å…¥ã‚Œã‚‹ã€ç†ç”±ã¯æœ€æ–°ç‰ˆãŒã¾ã ã‚¢ãƒ¬ãªã®ã§ã€‚

```
$ sudo su
# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh
$ sudo yum remove td-agent-1.1.20-0.x86_64
$ sudo yum install td-agent-1.1.19-0.x86_64
$ td-agent --version
td-agent 0.10.45
```

ã§ã€yum ã® fastestmirror ã‚’å°å…¥ã—ã¦ã„ãŸã‚Š update ã™ã‚‹ã¨æŠ˜è§’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸã®ãŒæœ€æ–°åŒ–ã•ã‚Œã¦ã—ã¾ã†ã®ã§ ```/etc/yum.conf``` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã€‚

```
exclude=td-*
```

# å—ä¿¡å´ï¼ˆã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼å´ï¼‰ã®è¨­å®š

## elasticsearch ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å°å…¥
å—ä¿¡å´ï¼ˆã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼å´ï¼‰ã« fluentd ã® [elasticsearch ãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://github.com/uken/fluent-plugin-elasticsearch)ã‚’å°å…¥ã€gemã§å…¥ã‚Œã‚‹ã¨ã libcurl-devel, gcc ãŒå¿…é ˆã§ã™ã€‚

```
# yum install libcurl-devel gcc
# /usr/lib64/fluent/ruby/bin/gem install fluent-plugin-elasticsearch
```

## Elasticsearch ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¤–éƒ¨ãƒ¬ãƒã‚¸ãƒˆãƒªã®è¿½åŠ (EPEL)ã‚’ãŠã“ãªã„ã¾ã™ã€‚ã¾ãŸ Elasticsearch ã«ã¯ java ãŒå¿…è¦ãªã®ã§ãã‚Œã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼ˆå€‹äººçš„ã«ã¯ã€java å…¥ã‚Œã‚‹ã®å‡„ã„å«Œã ã‘ã©ï½—ï¼‰ã€‚ã‚ã¨ã¯å½¢æ…‹ç´ è§£æå™¨ã® Kuromoji ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ã¤ã„ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ã‚ˆã•ã’ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```
# rpm --import http://packages.elasticsearch.org/GPG-KEY-elasticsearch
# vi /etc/yum.repos.d/elasticsearch.repo
[elasticsearch-1.1]
name=Elasticsearch repository for 1.1.x packages
baseurl=http://packages.elasticsearch.org/elasticsearch/1.1/centos
gpgcheck=1
gpgkey=http://packages.elasticsearch.org/GPG-KEY-elasticsearch
enabled=1

# yum install elasticsearch java-1.7.0-openjdk
# chkconfig --add elasticsearch
# chkconfig elasticsearch on
# service elasticsearch start
```

ã‚“ã§ã‚‚ã£ã¦ã€å‹•ä½œã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

```
$ curl -X GET http://localhost:9200/
{
  "status" : 200,
  "name" : "Wilbur Day",
  "version" : {
    "number" : "1.1.2",
    "build_hash" : "e511f7b28b77c4d99175905fac65bffbf4c80cf7",
    "build_timestamp" : "2014-05-22T12:27:39Z",
    "build_snapshot" : false,
    "lucene_version" : "4.7"
  },
  "tagline" : "You Know, for Search"
}
```

## Apache ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã“ã“ã¯ã€ã„ã¤ã‚‚ã®ã”ã¨ãã™ã€‚ServerName ã‚’å¼„ã£ã¦ãŠãã¨ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ãŒã§ãªã„ã®ã§ã‚ã‚Œã—ã¨ãã¾ã™ã€‚kibana ã‚’èµ·å‹•ã™ã‚‹ã ã‘ãªã®ã§ nginx ã§ã‚‚okãªã®ã§ã“ã“ã‚‚è¶£å‘³ã®å•é¡Œã§ã™ã€‚

```
# yum install httpd
# /etc/init.d/httpd start
# chkconfig httpd on
```

## kibana ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
3.1.0 æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(2014/7/4æ™‚ç‚¹)ã€‚

```
# curl -sL https://download.elasticsearch.org/kibana/kibana/kibana-3.1.0.tar.gz | sudo tar zxf - -C /var/www/html
# mv /var/www/html/kibana-3.1.0 /var/www/html/kibana
# /etc/init.d/httpd restart
```

## ã‚¢ã‚¯ã‚»ã‚¹
http://localhost/kibana ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ kinaba ã®åˆæœŸç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
![kibana.png](https://qiita-image-store.s3.amazonaws.com/0/44540/e9662824-9689-352d-b407-43f17532d629.png)

## fluentd ã®å®šç¾©
è»¢é€ã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã™ã‚‹æ„å‘³ã§ ```type stdout``` ã‚’æŒ‡å®šã—ã¦ã¾ã™ã€‚ é‹ç”¨å§‹ã‚ã‚‹å‰ã¯ ```/var/log/td-agent/td-agent.log``` ã«å‡ºåŠ›ã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã—å¾®èª¿æ•´ã—ãªãŒã‚‰ç†è§£ï¼†å®šç¾©ã—ãŸæ–¹ãŒã„ã„ã§ã™ã€‚

```
<source>
  type forward
  port 24224
</source>


<match apache.**>
  type copy

  <store>
    type stdout
  </store>

  <store>
    type elasticsearch
    host elasticsearch IPã‚¢ãƒ‰ãƒ¬ã‚¹
    port 9200
    type_name access_log_2
    logstash_format true
    logstash_prefix apache_access
    logstash_dateformat %Y%m
  </store>

 </match>
```

# é€ä¿¡å´ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå´ï¼‰

## fluentd ã®å®šç¾©
fluentd ã® apache2 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå†…å®¹ã‚’ elasticsearch ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚ã‚‹ã‚µãƒ¼ãƒã«è»¢é€ã—ã¾ã™ã€‚ã“ã“ã§ã‚‚ ```type stdout``` ã‚’æŒ‡å®šã—ã¦ã¾ã™ã€‚ é‹ç”¨å§‹ã‚ã‚‹å‰ã¯ ```/var/log/td-agent/td-agent.log``` ã‚’è¦‹ã¤ã¤è¨­å®šã—ãŸæ–¹ãŒãƒ™ã‚¹ãƒˆã§ã™ã€‚

```
<source>
  type tail
  path /var/log/httpd/access_log
  tag apache.combined
  pos_file /var/log/td-agent/httpd-access.log.pos
  format apache2
</source>

<match apache.**>
  type copy

  <store>
    type stdout
  </store>

  <store>
    type forward
    buffer_chunk_limit 256m
    buffer_queue_limit 128
    flush_interval 5s
    <server>
      host elasticsearch IPã‚¢ãƒ‰ãƒ¬ã‚¹
      port 24224
    </server>
  </store>
</match>
```

# kibana
fluentd ã®è¨­å®šã€Elasticsearch ã§ãƒ‡ãƒ¼ã‚¿ãŒæºœã¾ã£ã¦ãã‚‹ã¨ã‚ˆã†ã‚„ããƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚ã¡ãªã¿ã«ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¦ãªã„ã¨ kibana ã§è§£æã§ããªã„ã¨ã„ã†ã‹é¢ç™½ããªã„ã®ã§é©å½“ã«ã€wget ã¨ã‹ curl ã§ã‚µãƒ¼ãƒ“ã‚¹å´ã‚’å©ã„ã¦ãŠãã“ã¨ã€

## kibana ã®ä½¿ã„æ–¹
ãã£ã¨ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚ˆã‚Šé›£ã—ã„ã‹ã‚‚ã€‚ã‚ãŸã—ã‚‚å‹‰å¼·ä¸­ã§ã™ã€‚
![kibana2.png](https://qiita-image-store.s3.amazonaws.com/0/44540/6ba2b01b-d330-79ad-7e8a-5cde243f159b.png)


> [fluentd + Elasticsearch + Kibanaã§å§‹ã‚ã‚‹ãƒ­ã‚°è§£æ (ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç·¨)](http://blog.excale.net/index.php/archives/1929)

# æ¬¡å›
fluentd ã‚’å¤šæ®µæ§‹æˆã«ã—ã¤ã¤å†—é•·åŒ–æ§‹æˆã—ãŸã‚Šã¨éŠã‚“ã§ã€ã‚‚ã¨ã„å‹‰å¼·ã—ã¦ã¿ã‚‹ã¤ã‚‚ã‚Š

> [fluentdã§å§‹ã‚ã‚‹ãƒ­ã‚°ç®¡ç†ã€ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰è¨­å®šã¾ã¨ã‚ã€‘](http://blog.excale.net/index.php/archives/1997)








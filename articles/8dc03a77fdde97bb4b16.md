---
title: "ã„ã¾ã•ã‚‰ fluentd ã‚’ã¯ã˜ã‚ã¦ã¿ãŸMongoDB ãªã«ãã‚Œç¾å‘³ã—ã„ã®ï¼Ÿã€ãã®ï¼“"
emoji: "ğŸ“"
type: "tech"
topics: Fluentd MongoDB Vagrant
published: true
---

# ã„ã¾ã•ã‚‰ fluentd ã¯ã˜ã‚ã¦ã¿ã‚‹ï¼“
 [MongoDB](http://www.mongodb.org/) ã“ã‚Œã‚‚å‰ã‹ã‚‰æ°—ã«ãªã£ã¦ã„ãŸã®ã§èª¿ã¹ã¦ã¿ãŸã€‚[EPEL](https://fedoraproject.org/wiki/EPEL) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚“ã§ãã“ã‚‰è¾ºã¯åˆ¤ã£ã¦ã‚‹ã¨æ€ã†ã‘ã©ã‚ˆã‚ã—ãã€‚ã‚ã¨ã€Œ[ãã‚Œç¾å‘³ã—ã„ã®ï¼Ÿ](https://www.google.co.jp/webhp?sourceid=chrome-instant&ion=1&espv=2&es_th=1&ie=UTF-8#q=%E3%81%AA%E3%81%AB%E3%81%9D%E3%82%8C%E7%BE%8E%E5%91%B3%E3%81%97%E3%81%84%E3%81%AE%EF%BC%9F)ã€ã£ã¦ç´ ã§ã¯è¨€ã‚ãªã„ã®ã§ãã“ã‚“ã¨ã“ã‚‚ã‚ˆã‚ã—ãï½—ï¼ˆä¼šç¤¾ã®åŒåƒšãŒè¨€ã†ã‘ã©ã‚¤ãƒ©ã£ã¨ãã‚‹ã‚ˆã­ï½—ï¼‰ã€‚

ã‚ˆã†ã‚„ã£ã¨ã“ã®æ§‹æˆã‚’ä½œã‚Œã‚‹ï½—
![fluentd_2.png](https://qiita-image-store.s3.amazonaws.com/0/44540/b8aaa3d4-3dba-ae89-f3e2-7f018575f8a4.png)

# MongoDB ã£ã¦
ã„ã‚ã‚†ã‚‹ noSQL ã«åˆ†é¡ã•ã‚Œã‚‹ç‰©ã§ã™ã€‚ç‰¹ã«ã“ã® MonogoDB ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæŒ‡å‘å‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã—ã¦ç‰¹ç­†ã™ã¹ãç‚¹ã¨ã—ã¦ã€ŒJSONã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãã®ã¾ã¾DBã«ã€ã£ã¦ã„ã†ã“ã¨ã€‚ã“ã‚Œã™ã”ã„ã“ã¨ã™ã€‚ã‚ã¨åå‰ã®ç”±æ¥ãŒã€â€humongousâ€ï¼ˆã°ã‹ã§ã‹ã„ï¼‰ã£ã¦å§‹ã‚ã¦çŸ¥ã‚Šã¾ã—ãŸã€‚ãã‚Šã‚ƒãƒ“ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã£ã¦èªå¥ã§æ²¢å±±å¼•ã£æ›ã‹ã‚‹ã‚ã€‚

> [MongoDBã®è–„ã„æœ¬(The Little MongoDB Book)](http://www.cuspy.org/diary/2012-04-17)
> [ã¯ã˜ã‚ã¦ã®mongoDB å…¥é–€ç·¨ æ§‹ç¯‰ãƒ»è¨­å®šãƒ»ãƒ„ãƒ¼ãƒ«ã¾ã¨ã‚](http://blog.bot.vc/2012/12/mongodb/)
> [åˆå¿ƒè€…å‘ã‘MongoDBã®ã‚­ãƒ›ãƒ³ï¼ - SlideShare](http://www.slideshare.net/tetsutarowatanabe/mongo-db-32210761)

# MongoDB ã„ã‚“ã™ã¨ãƒ¼ã‚‹
/etc/yum.repos.d/mongodb.repo ã‚’ä½œæˆã—ã€MongoDB ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```lang:/etc/yum.repos.d/mongodb.repo
[mongodb]
name=MongoDB Repository
baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64/
gpgcheck=0
enabled=1
```

```lang:command
$ sudo yum -y install mongo-10gen mongo-10gen-server
```

## èµ·å‹•ã¨è‡ªå‹•èµ·å‹•ã®è¨­å®š
ãŠç´„æŸã®ã‚³ãƒãƒ³ãƒ‰ã€‚2014/06/21ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ MongoDB shell version: 2.6.3ã€€ã‚‰ã—ã„ã„ã€‚
ã‚ã¨ MongoDB ã®LISTENãƒãƒ¼ãƒˆã¯ 27017ï¼ˆ```netstat -a | grep mongo``` ã§ã‚ã‹ã‚‹ã‚ˆï¼‰ã€‚

```lang:command
$ sudo /etc/init.d/mongod start
$ sudo chkconfig mongod on
```

> MongoDBãƒ„ãƒ¼ãƒ« : http://robomongo.org/ 

# fluentd ã®è¨­å®š
LTSV, MongoDB ã‚‚è¨­å®šã—ã¦ã‚‹ã®ã§ã‚ã¨ã¯ fluentd ã®è¨­å®šã ã‘ã€‚

## é€ä¿¡å´ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå´ï¼‰
Apache ã®ãƒ­ã‚°(LTSV)ã‚’ç›£è¦–ã— fluentd ã‚µãƒ¼ãƒã«è»¢é€ã™ã‚‹è¨­å®šã€‚fluentd ã®å†èµ·å‹•ãŒå¿…è¦ã§ã™ã€‚

```lang:/etc/td-agent/td-agent.conf
<source>
  type tail
  path /var/log/httpd/access_log
  format ltsv
  time_key time
  time_format %d/%b/%Y:%H:%M:%S %z
  tag td.apache.access
  pos_file /var/log/td-agent/apache_access.pos
  tag mongo.apache
</source>

<match mongo.**>
  type forward
  buffer_chunk_limit 256m
  buffer_queue_limit 128
  flush_interval 5s
  <server>
    host 192.168.11.106
    port 24224
  </server>
</match>
```

## å—ä¿¡å´ï¼ˆã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼å´ï¼‰
è»¢é€ã•ã‚ŒãŸæƒ…å ±ã‚’ MongoDB ã«è¿½åŠ ï¼†ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™è¨­å®šã€‚fluentd ã®å†èµ·å‹•ãŒå¿…è¦ã§ã™ã€‚

```lang:/etc/td-agent/td-agent.conf
<match mongo.**>
  type copy

  <store>
    type file
    time_slice_format %Y%m%d_%H%M
    time_slice_wait 1m
    path /var/log/td_log/td_access_test
    time_format %Y%m%dT%H%M%S%z
  </store>

  <store>
    type mongo
    database apache
    collection access
    host localhost
    port 27017
    flush_interval 10s
  </store>
</match>
```

# MongoDB ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ã¿ã‚‹
ãã£ã¨ã“ã“ã¾ã§ãã‚Œã°Goodã€ã‚‚ãƒ¼ã¾ã‚“ãŸã„ã€‚MongoDB ã«ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã¯ãšã€‚ãã‚“ãªè¨³ã§ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚
192.168.11.104(Apach) â‡’ 192.168.11.106(MongoDB) ã«ãƒ‡ãƒ¼ã‚¿ãŒã¯ã„ã£ã¦ã¾ã™ï¼ï¼

```lang:command
$ mongo
MongoDB shell version: 2.6.3
connecting to: test
> show dbs
admin   (empty)
apache  0.078GB
local   0.078GB
> use apache
switched to db apache
> show collections
access
system.indexes
> db.access.find();
{ "_id" : ObjectId("53a6bdcb297b502c2a000001"), "domain" : "192.168.11.104", "host" 
```

# æ¬¡ã¯
[GrowthForecast ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚’å‹‰å¼·ã—ã¦ã¿ã‚‹ï¼ˆãã®ï¼”ï¼‰ã®äºˆå®š](http://qiita.com/murachi1208/items/9d23a78c316208dbe85d)ã§ã™ï½—

## å‚è€ƒã‚µã‚¤ãƒˆ
> [ã•ãã‚‰ã‚µãƒ¼ãƒãƒ¼ã®VPSç’°å¢ƒã«fluentdã¨MongoDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](http://netdiever.com/archives/12241)
> [ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ipã‚’æŒ‡å®šã™ã‚‹](http://openbook4.me/sections/156)


---
title: "Apache Solrï¼ˆJDK7, Solr 4.9.1, jetty 9ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ãŸã€ãã®ï¼‘"
emoji: "ğŸ“"
type: "tech"
topics: Vagrant Solr jetty
published: true
---

# Apache Solr
å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¨è¨€ãˆã°æ—¬ã®ã€ŒElasticsearchã€ã§ã™ãŒã€ãŸã¾ãŸã¾ Apache Solr ã‚’èª¿æŸ»ã™ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ãã®ãƒ¡ãƒ¢ã§ã™ã€‚ã—ã‹ã—æ¯ã‚ŒãŸæ„Ÿã˜ãŒã™ã‚‹ Solr ã ã‘ã©æ„å¤–ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«æ‰‹é–“å–ã£ãŸã€‚

> [æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®å¸¸è­˜ã‚’Apache Solrã§èº«ã«ã¤ã‘ã‚‹](http://www.atmarkit.co.jp/ait/articles/1111/18/news148.html)

| ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|:-----------|:----------|
|Java    |1.7.0      | 
|Apache Solr         |4.9.1    |
|Jetty        |9.2.10     | 

# Vagrant 
ã„ã¤ã‚‚ã®å®šç¾©ã ã£ã¦ã°ã•ï½—

```
config.vm.define :solr do |node|
  node.vm.network :private_network, ip: "192.168.11.210"
  node.vm.provider "virtualbox" do |v|
    v.customize ["modifyvm", :id, "--memory", 512]
  end
end
```

# Java ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
Solr 4.9ç³»ã¯ã€JDK 7ä»¥ä¸Šã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„ã‚ˆã€ã£ã¦ã©ã“ã‹ã§è¦‹ãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹ã®ã§ã€JDK 7 ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ,é–‹ç™ºç’°å¢ƒ, ant ã¨ wget ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã¾ã‚ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã ã‘ã§ã‚‚ã„ã„ã£ã¡ã‚ƒã„ã„ã¨æ€ã†ã‘ã©ã­ï½—

```
# yum install java-1.7.0-openjdk.x86_64 java-1.7.0-openjdk-devel.x86_64 ant.x86_64 wget
```
# Apache Solr ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èµ·å‹•ç¢ºèª
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã¯ã€ã©ã“ã§ã‚‚ã„ã„ã®ã§ã™ãŒç‰¹ã«ã“ã ã‚ã‚Šãªã„ã®ã§ã€/var/local ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸï¼ˆã¡ã‚ƒã‚“ã¨è€ƒãˆã‚‹ã¨ /opt ãŒã„ã„ã‹ã‚‚ã­ï½—ï¼‰ã€‚

```
$ wget http://ftp.riken.jp/net/apache/lucene/solr/4.9.1/solr-4.9.1.tgz
$ tar xvfz solr-4.9.1.tgz
$ sudo cp -rp solr-4.9.1 /var/local/solr/
$ cd /var/local/solr/example
$ sudo java -jar start.jar
```

ãšã‚‰ãšã‚‰ãšã‚‰ãƒ¼ã£ã¦ãªã‚“ã ã‹æ»ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‘ã©ã‚¨ãƒ©ãƒ¼ã‚‰ã—ãè¡¨ç¤ºãŒã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€Solr ãŒèµ·å‹•ã—ã¦ã¾ã™ã®ã§ã€‚ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚‹ã‹ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ã¾ã™ã€‚

ç®¡ç†ç”»é¢ã€€ï¼šã€€http://192.168.11.210:8983/solr
æ¤œç´¢ç”»é¢ã€€ï¼šã€€http://192.168.11.210:8983/solr/collection1/browse

![solr-1.png](https://qiita-image-store.s3.amazonaws.com/0/44540/edc30ff2-c474-4d4b-1bcc-2b64da11f62b.png)

## ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã€æ¤œç´¢ã—ã¦ã¿ã‚‹
é©å½“ãªã¨ã“ã«ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```xml:solrtest.xml
<add>
    <doc>
        <field name="id">1</field>
        <field name="name">hoge hoge</field>
    </doc>
    <doc>
        <field name="id">2</field>
        <field name="name">ã‚¢ãƒ‘ãƒƒãƒ</field>
    </doc>
    <doc>
        <field name="id">3</field>
        <field name="name">æ±äº¬ç‰¹è¨±è¨±å¯å±€</field>
    </doc>
</add>
```

curl ã‚’ä½¿ã£ã¦ç™»éŒ²ã—ã¦ã¿ã¾ã™ã€‚

```
$ curl 'http://localhost:8983/solr/collection1/update?commit=true&indent=true' --data-binary @solrtest.xml -H 'Content-Type: text/xml'
<?xml version="1.0" encoding="UTF-8"?>
<response>

<lst name="responseHeader">
  <int name="status">0</int>
  <int name="QTime">155</int>
</lst>
</response>
```

curl ã‚’ä½¿ã£ã¦æ¤œç´¢ã—ã¦ã¿ã¾ã™ã€‚

```
# curl "http://localhost:8983/solr/collection1/select?q=hoge&wt=json&indent=true"
{
  "responseHeader":{
    "status":0,
    "QTime":10,
    "params":{
      "indent":"true",
      "q":"hoge",
      "wt":"json"}},
  "response":{"numFound":1,"start":0,"docs":[
      {
        "id":"1",
        "name":"hoge hoge",
        "_version_":1498497071919923200}]
  }}
```

# Jetty 9 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã— Solr ã‚’èµ·å‹•
ã“ã“ã¾ã§é †èª¿ã§ã™ãŒã€ã“ã£ã‹ã‚‰ãŒå¤šå°‘ã¯ã¾ã‚Šã¾ã—ãŸã€‚

## èµ·å‹•ã«å¤±æ•—ã™ã‚‹ï½—
æŠ˜è§’ãªã®ã§ Jetty 9 ã‚’ä½¿ã£ã¦ã€€Solr ã‚’èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚ãã—ã¦èµ·å‹•ã—ãªã„ã£ã¦ã‚ªãƒã‚’å†ç¾ã—ã¾ã™ã€‚

```
$ wget http://download.eclipse.org/jetty/stable-9/dist/jetty-distribution-9.2.10.v20150310.tar.gz
$ tar zxvf jetty-distribution-9.2.10.v20150310.tar.gz
$ sudo cp -rp jetty-distribution-9.2.10.v20150310 /var/local/jetty/
$ sudo cp /var/local/jetty/bin/jetty.sh /etc/init.d/jetty
```

jetty ã®èµ·å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ /etc/default/jetty ã«è¨­å®šã—ã¾ã™ã€‚

```text:/etc/default/jetty
JAVA_HOME=/etc/alternatives/java_sdk
JAVA_OPTIONS="-Djava.awt.headless=true -server -XX:+UseGCOverheadLimit -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+UseTLAB -XX:MaxPermSize=128m -Xms512M -Xmx1024M $JAVA_OPTIONS -Dsolr.solr.home=/var/local/solr/example/solr"
NO_START=0
JETTY_ARGS=jetty.port=8983
JETTY_USER=root
JETTY_HOME=/var/local/jetty
JETTY_LOGS=/var/local/solr/example/logs
```

ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¨ã‚‹ï½—

```
# service jetty start
```

## å‹•ã‹ãªã„ç†ç”±ãŒã‚ã‹ã£ãŸ
jettyã§å‹•ã‹ã™ãŸã‚ã®ç’°å¢ƒãŒæ•´å‚™ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã‚ªãƒã§ã—ãŸã€‚ãªã®ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã—ã¦å†æŒ‘æˆ¦ã—ã¾ã™ã€‚

```
$ sudo cp -a /var/local/solr/example/webapps/solr.war /var/local/jetty/webapps/solr.war
$ sudo cp -a /var/local/solr/example/contexts/solr-jetty-context.xml /var/local/jetty/webapps/solr.xml
$ sudo cp -a /var/local/solr/example/lib/ext/* /var/local/jetty/lib/ext/
$ sudo service jetty start
```

ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸãƒ¼ (^^

## INFO ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
INFO ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚¦ã‚¶ã‚¤ã¨æ€ã£ãŸã‚‰ log4j ã®è¨­å®šãŒã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ã‚ˆã†é©å½“ã«ç·¨é›†ã—ã¾ã™ã€‚ã“ã“ã‚‰ã¸ã‚“ã¯ã€å¾Œã€…ã«éŸ¿ãã®ã§ã¡ã‚ƒã‚“ã¨è¨­å®šã—ã¨ã„ãŸæ–¹ãŒè‰¯ã„ã§ã™ã€‚

```text:/var/local/jetty/resources/log4j.properties
# This is not needed by Jetty - but it helps with many web apps.

log4j.rootLogger=INFO, file
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%-4r [%t] %-5p %c %x - %m%n

#- size rotation with log cleanup.
log4j.appender.file=org.apache.log4j.RollingFileAppender
log4j.appender.file.MaxFileSize=4MB
log4j.appender.file.MaxBackupIndex=9

#- File to log to and log format
solr.log=/var/local/solr/example/logs
log4j.appender.file.File=${solr.log}/solr.log
log4j.appender.file.layout=org.apache.log4j.PatternLayout
log4j.appender.file.layout.ConversionPattern=%-5p - %d{yyyy-MM-dd HH:mm:ss.SSS}; %C; %m\n
```

ã‚ˆã£ã—ã‚ƒã€‚

# å‚è€ƒã«ã•ã›ã¦é ‚ã„ãŸã‚µã‚¤ãƒˆã•ã¾

> [Ubuntu12.04ã«Jetty9ã¨solr4.5.1ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã‚‹](http://ma2kubo.hateblo.jp/entry/2013/11/15/054153)
> [Apache Solrã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](http://kazuhei.hatenablog.com/entry/2014/07/13/010109)
> [apache solr ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](http://qiita.com/inouet/items/fe1e4a1d506a8dc01b27)






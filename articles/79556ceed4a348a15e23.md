---
title: "postfixã§è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å—ä¿¡ã™ã‚‹è¨­å®šã—ãŸã‚‰SPAMã¾ã¿ã‚Œã§çµå±€fail2banã‚‚ã„ã‚Œã‚‹ã¾ã§ã®å·»"
emoji: "ğŸ“"
type: "tech"
topics: postfix CentOS fail2ban
published: true
---

postfixã§ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’ã›ãšè¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡

å‰²ã¨ä»Šæ›´æ„ŸãŒã‚ã‚Šã¾ã™ãŒã€Œpostfixã§è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å—ä¿¡ã™ã‚‹ã€ãŒç°¡å˜ãªã®ã§è¨­å®šã—ã¦ã¿ã¾ã™ã€‚
ãªã‚“ã§ï¼Ÿã£ã¦è¨€ã‚ã‚Œã‚‹ã¨ãƒ¡ãƒ¼ãƒ«å°‚ç”¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ã„ãŸã®ã§ã™ãŒã€VPSãŒå…ˆã«åˆ‡ã‚Œã¦ã—ã¾ã„ä½™åˆ†ãªãŠé‡‘å‡ºã—ãŸããªã„ãªãƒ¼ã£ã¦æ€ã£ã¦ã®ã“ã¨ãªã®ã§ã™ï¼ˆç´ ç›´ã«ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã§è¨­å®šã™ã‚Œã°ã„ã„ã®ã ãŒï¼‰ã€‚
ã‚ã¨ã€Œè¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å—ä¿¡ã™ã‚‹ã€ã ã‘ã§ã¯ã€ã‚‚ã£ãŸã„ãªã„ã®ã§ SPAMãƒ¡ãƒ¼ãƒ«å¯¾ç­–ã€fail2ban ã§ BAN ã™ã‚‹æ–¹æ³•ã‚‚æ›¸ã„ã¦ãŠãã¾ã™ã€‚

OSå…¥ã‚Œæ›¿ãˆã‚‹å‰ã¯ã€ä¸€å¿œè‰²ã€…ã¨è¨­å®šã—ã¦ã¾ã—ãŸã€‚
ãƒ»[Postfixã®è¨­å®šã®å·»](http://www.sea-bird.org/pukiwiki_utf/index.php?Postfix%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E5%B7%BB)


# postfixã§è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å—ä¿¡ã™ã‚‹
ã¨ã‚Šã‚ãˆãšä¸‹è¨˜ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã—ã¦ã¿ã‚‹ã€‚åŒã˜ã“ã¨ã‚„ã£ã¦ã„ã‚‹ã®ã§çªã£è¾¼ã¿ã¯ãªã—ã§ãŠé¡˜ã„ã—ãŸã„ã€‚
ãƒ»[postfixã§ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’ã›ãšè¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡](https://qiita.com/shimano_equipped/items/4fd68ec2e63b17fc25ab)
ãƒ»[postfixã§è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å—ä¿¡ã™ã‚‹](https://blog.goo.ne.jp/takawaguchi/e/fac490cce3d6e78229e8c496d01d8f89)

postfixã®è¨­å®šã¯æ—¢ã«çµ‚ã‚ã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã‚’å‰æã§ã€`domain.com` ã¨ã„ã†è¿½åŠ ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ã€`/etc/postfix/main.cf` ã® mydestination ã« `domain.com` ã¨è¿½åŠ ã™ã‚Œã°ã‚ˆã„ã€‚ã‚ã¨ postfix ã®å†èµ·å‹•ã‚’å¿˜ã‚Œãšã«ã€‚

```/etc/postfix/main.cf
mydestination = $myhostname, localhost.$mydomain, localhost, domain.com
```

ã¨ã‚Šã‚ãˆãšã“ã‚Œã§ `admin@domain.com` â‡’ å…ƒãƒ‰ãƒ¡ã‚¤ãƒ³ã® `admin@xxxxxx.com` ã«ã‚‚é…é€ã•ã‚Œã‚‹ã£ã¦å¯¸æ³•ã€‚
postfixã®ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„å ´åˆã¯ã€ä¸‹è¨˜ã‚µã‚¤ãƒˆãŒè©³ã—ãèª¬æ˜ã—ã¦ã„ã‚‹ã€‚
ãƒ»[Postfix + dovecot ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®è¨­å®šã‚’æ·±å €ã™ã‚‹](https://web-creators-hub.com/linux/postfix3/)

# ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®ç¬¬ä¸‰è€…ä¸­ç¶™ãƒã‚§ãƒƒã‚¯
æ°—ã«ãªã‚Šã ã™ã¨æ°—ã«ãªã‚‹ãƒ¡ãƒ¼ãƒ«ã®ä¸­ç¶™ã€‚ã“ã‚Œè‡ªåˆ†ãŒåŠ å®³è€…ã«ãªã‚‹ã®ã§æ´’è½ã«ãªã‚‰ãªã„ã®ã§ä¸€åº¦ã¯ç¢ºèªã—ã¦ãŠã„ãŸæ–¹ãŒã‚ˆã„ã€‚
ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚µã‚¤ãƒˆãŒã‚ã‚‹ã®ã§ãã“ã§ç¢ºèªã™ã‚‹ã€‚
ãƒ»[ç¬¬ä¸‰è€…ä¸­ç¶™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹](http://px1.xaffy.net/%E7%AC%AC%E4%B8%89%E8%80%85%E4%B8%AD%E7%B6%99%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B) â˜…ãŠã™ã™ã‚
ãƒ»[open relay checker](http://check.jippg.org/)

# SPAMã¾ã¿ã‚Œã«ãªã£ã¦ã„ãŸâ€¦
ã¨ã‚Šã‚ãˆãšSPAMãƒ¡ãƒ¼ãƒ«å¯¾ç­–ã¨ã—ã¦ `smtpd_client_restrictions` ã¨ `smtpd_sender_restrictions` ã‚’è¨­å®šã—ã¦ãŠãã€‚
ã“ã‚Œã ã‘ã§ã‚‚ã ã„ã¶ãƒã‚·ã«ãªã‚‹ãŒã€ã‚ã¾ã‚Šã«ã‚¦ã‚¶ã‚¤SPAMã•ã‚“ã¯ ãƒ‰ãƒ¡ã‚¤ãƒ³ or IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ‹’å¦ã™ã‚‹ã¨ã„ã„ãŒâ€¦ï¼ˆã“ã‚Œä»¥ä¸Šã«ã†ã–ã†ã–ã•ã‚“å¯¾å¿œãŒå¿…è¦ã ã£ãŸï¼‰ã€‚

```/etc/postfix/main.cf
smtpd_client_restrictions = permit_mynetworks,
                              reject_rbl_client spamcop.net,
                              reject_rbl_client dynablock.wirehub.net,
                              reject_rbl_client opm.blitzed.org,
                              reject_rbl_client relays.visi.com,
                              reject_rbl_client sbl.spamhaus.org,
                              permit

smtpd_sender_restrictions = reject_unknown_sender_domain
```
ãƒ‰ãƒ¡ã‚¤ãƒ³ or IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ‹’å¦ã®æ–¹æ³•ã¯ä¸‹è¨˜ã‚’å‚ç…§
ãƒ»[Postfixã§spamãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ƒãƒ»é€ä¿¡è€…ã«ã‚ˆã‚‹åˆ¶é™ã®å·»](http://www.sea-bird.org/pukiwiki_utf/index.php?Postfix%E3%81%A7spam%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%81%E4%BF%A1%E5%85%83%E3%83%BB%E9%80%81%E4%BF%A1%E8%80%85%E3%81%AB%E3%82%88%E3%82%8B%E5%88%B6%E9%99%90%E3%81%AE%E5%B7%BB)

# unknown ã•ã‚“ãŒæ¶ˆãˆãªã„äº‹ä¾‹ï¼ˆç™ºç”Ÿç·¨ï¼‰
`/var/log/maillog` ã‚’ã¿ã¦ã„ã‚‹ã¨ãªã‚“ã ã‹æ€ªã—ã„ãƒ­ã‚°ãŒâ€¦ã—ã‹ã‚‚ç›¸å½“ã‚¢ã‚¿ãƒƒã‚¯ãŒã‚ã‚‹ã€‚

```text
Mar 22 11:08:43 ns postfix/smtpd[7001]: connect from unknown[92.118.38.42]
Mar 23 11:09:00 ns postfix/smtpd[7001]: warning: unknown[92.118.38.42]: SASL LOGIN authentication failed: UGFzc3dvcmQ6
```

ã“ã® `connect from unknown` ã§ã™ãŒã€ã©ã†ã‚„ã‚‰ `smtpd_client_restrictions` ã« `reject_unknown_client`(é€†å¼•ããŒã§ããªã„ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯è¨±å¯ã—ãªã„)ã‚’æŒ‡å®šã™ã‚‹ã¨ã„ã„ã‚‰ã—ã„ã€‚
ãƒ»[ã‚¹ãƒ‘ãƒ ãƒ¡ãƒ¼ãƒ«ã‚’è»¢é€ã—ãªã„ã‚ˆã†ã«ã™ã‚‹](https://blog.jicoman.info/2015/11/postfix_not_send_spam_mail/)

```/etc/postfix/main.cf
smtpd_client_restrictions = permit_mynetworks,
                              reject_rbl_client spamcop.net,
                              reject_rbl_client dynablock.wirehub.net,
                              reject_rbl_client opm.blitzed.org,
                              reject_rbl_client relays.visi.com,
                              reject_rbl_client sbl.spamhaus.org,
                              reject_unknown_client,ã€€ã€€â˜…ã“ã‚Œ
                              permit
```

çµæœã€ç›¸å¤‰ã‚ã‚‰ãšâ€¦ç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„ã®ã‹ã„ï¼ï¼ã¨å«ã‚“ã§ã¿ã‚‹ã€‚

# fail2ban ã‚’å…¥ã‚Œã¦ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯¾ç­–ã—ã¦ã¿ã‚‹ â€»unknown ã•ã‚“ãŒæ¶ˆãˆãŸï¼ˆè§£æ±ºç·¨ï¼‰
ã©ã†ã‚„ã‚‰ unknown ã•ã‚“ã¨ã„ã†ã‹ postfixã«å¯¾ã—ã¦ã®ã‚¢ã‚¿ãƒƒã‚¯ã€ŒSASL LOGIN authentication failed: authentication failureã€ã§ã™ãŒ `fail2ban` ä½¿ã†ã¨æ¥½ã«å¯¾å¿œã§ãã‚‹ã‚‰ã—ã„ã®ã§å°å…¥ã—ã¦ã¿ã¾ã™ã€‚
CentOS8 ã§ã¯ã€ã¾ã  `fail2ban` ã¯æ¨™æº–ã§ã‚¤ãƒ³ã‚¹ã‚³ã§ããªã„ã®ã§ EPEL ã‚’å…ˆã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

```cmd
# dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
# dnf -y install fail2ban
# cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
# vi /etc/fail2ban/jail.local
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã€‚ã¨ã‚Šã‚ãˆãšä»Šå› postfix ã ã‘ãªã®ã§ãã“ã‚’è¿½åŠ ï¼†ä¿®æ­£ã—ã¦ã„ãã€‚

```/etc/fail2ban/jail.local
[postfix-sasl]
enabled = true
filter   = postfix[mode=auth]
port     = smtp,465,submission,imap,imaps,pop3,pop3s
action = iptables-multiport[name=postfix-sasl, port="smtp,smtps", protocol=tcp]
logpath  = /var/log/maillog
bantime  = 604800
findtime = 86400
maxretry = 2
```

`fail2ban` ã‚’å†èµ·å‹•ã—å•é¡Œã® unknown ã•ã‚“ãŒ `/var/log/maillog` ã«è¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

# fail2ban ã§ BAN ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆç¢ºèªç·¨ï¼‰
`fail2ban` ã¯ã€ `iptable` ã§å•é¡Œã®ã‚¢ã‚¿ãƒƒã‚¯å…ƒã‚’å¼¾ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚æ’ä¹…çš„ã«è¨­å®šã•ã‚Œã‚‹ã®ã‹ã¨æ€ã£ãŸã‚‰ `fail2ban` ã‚’åœæ­¢ã™ã‚Œã°æ¶ˆãˆã‚‹ã‚‰ã—ã„ã€‚

ã“ã‚“ãªæ„Ÿã˜ã§è¨­å®šã•ã‚Œã‚‹ã®ã­ã€‚

```text
# fail2ban-client status postfix-sasl
Status for the jail: postfix-sasl
|- Filter
|  |- Currently failed: 3
|  |- Total failed:     1611
|  `- Journal matches:  _SYSTEMD_UNIT=postfix.service
`- Actions
   |- Currently banned: 7
   |- Total banned:     26
   `- Banned IP list:   92.118.38.66 92.118.38.82 213.251.5.208 91.134.145.129 193.56.28.130 78.128.113.94 45.142.195.2
```

ç‰¹ã«ãƒãƒã‚‹ã“ã¨ã¯ç„¡ã‹ã£ãŸã§ã™ãŒ `fail2ban` ã¯ã€å¤–ã«ã‚‚è¨­å®šã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ã®ã§éƒ½åº¦è¨­å®šã—ã¦ã„ãã¨ã„ã„ã‹ã‚‚ã€‚

`fail2ban` å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆæ§˜
ãƒ»[fail2banã‚’CentOS8ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹](https://north.thco.mp/2019/10/08/fail2ban-nftables-centos8/)
ãƒ»[fail2banã§postfixã®èªè¨¼å¤±æ•—å›æ•°ã«å¿œã˜ã¦æ’ä¹…çš„ã«é€ä¿¡å…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’banã™ã‚‹](https://qiita.com/ume3_/items/e3af13ef29d561728e4d)
ãƒ»[ã€CentOS7ã€‘ssh&postfixã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯¾ç­–-fail2ban](http://www.matsubarasystems.com/centos/fail2ban-postfix)
ãƒ»[ã‚¢ã‚¿ãƒƒã‚¯å¯¾ç­–fail2ban](https://kuragane.jp/fail2ban.htm)


---
title: "ã„ã¾ã•ã‚‰ fluentd v1 ã‚’ã¯ã˜ã‚ã¦ã¿ãŸã€ãã®ï¼‘"
emoji: "ğŸ“"
type: "tech"
topics: Fluentd Vagrant
published: true
---

# ã„ã¾ã•ã‚‰ fluentd v1 ã¯ã˜ã‚ã¦ã¿ã‚‹
ã€Œ[fluentd](http://www.fluentd.org/) + [Kibana](Kibana) + [elasticsearch](http://www.elasticsearch.org/)ã€ ã‚„ã‚‰ ã€Œfluentd + [MongoDB](http://www.mongodb.org/)ã€ã¨ãƒ­ã‚°è§£æã—ã¦DBã«å…¥ã‚Œã¤ã¤ã‚°ãƒ©ãƒ•åŒ–ã—ã¡ã‚ƒã†ãªã‚“ã¦å··ã§æµè¡Œã£ã¦ã„ã‚‹ãªï½ï½ã¨æŒ‡ã‚’ãã‚ãˆã¦ã¿ã¦ãŸã‚“ã§ã™ã€‚ãã—ã¦ï¼‘å¹´çµŒéãƒ»ãƒ»ãƒ»ãã‚ãã‚ã‚„ã‚‰ã­ã°ï¼ã¨é‡ã„è…°ã‚’ã‚ã’ã¦ã¿ã¾ã—ãŸã€‚ãã—ã¦ã¾ãŸãƒãƒã£ãŸï½—
â€»fluentd v2ãŒã§ã¦ãŠã‚Šã¾ã™ï½

# fluentd ã£ã¦
ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ã—ãŸã“ã¨ã‚ã‚‹äººãªã‚‰çµŒé¨“ãŒã‚ã‚‹ã‚ˆã†ã«å„ã‚·ã‚¹ãƒ†ãƒ ã«æ•£ã‚‰ã°ã£ãŸãƒ­ã‚°ã‚’åé›†ï¼†è§£æã€ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹ã®ã£ã¦ç°¡å˜ãã†ã§çµæ§‹å¤§å¤‰ãªä½œæ¥­ã§ã™ã‚ˆã­ã€‚[fluentd](http://www.fluentd.org/) ã¯ã€ruby ã§æ›¸ã‹ã‚ŒãŸãƒ­ã‚°è§£æãƒ„ãƒ¼ãƒ«ï¼ˆãƒ­ã‚°åé›†ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼Ÿï¼‰ã§ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã‚Šç°¡å˜ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸå¤šå½©ãª[å…¥å‡ºåŠ›ãƒ—ãƒ©ã‚°ã‚¤ãƒ³](http://docs.fluentd.org/ja/articles/)ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã—ã€ã“ã‚“ãªã®ãªã„ã‹ãªï¼Ÿã¨æ€ã†ã¨[åˆ¥é€”å…¬é–‹](http://www.fluentd.org/datasources)ã•ã‚Œã¦ã„ãŸã‚Šã¨æ®†ã©è‡ªåˆ†ã§ä½œæˆã™ã‚‹å¿…è¦ãŒãªã„ä½ã«å……å®Ÿã—ã¦ã„ã¾ã™ã€‚

> [fluentdã«ã‚ˆã‚‹ãƒ­ã‚°åé›†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ï½åŸºæœ¬ç·¨](http://success.tracpath.com/blog/2014/04/22/fluentd_opensource_log_management-2/)
> [Fluentdã«ãŠã‘ã‚‹ãƒ­ã‚°é‹ç”¨](http://qiita.com/kenzan100/items/9891a24263de77af6f31)

## ãƒãƒã£ãŸ
ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’å«ã€ã¨ã„ã‚ã‚Œãã†ã§ã™ãŒãƒ»ãƒ»ãƒ»ã€‚fluentd ã§ã®in/outã¯ã™ã¹ã¦ json ã§å‡¦ç†ã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã€‚
ãã®ãŸã‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«å¯¾ã—å…¥åŠ›ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«å¯¾å¿œã—ã¦ã„ãªã„ã¨ã ã‚ï½—ã€‚ã‹ã¨ã„ã£ã¦ã‚‚æ­£è¦è¡¨ç¾ã‚’å°‘ã—å‹‰å¼·ã™ã‚Œã°å¯¾å¿œå¯èƒ½ã€‚

# ã¨ã‚Šã‚ãˆãšåˆå¿ƒè€…ã‚‰ã—ãã‹ã‚‹ï½ãå®Ÿè£…ã—ã¦ã¿ã¾ã™
ã€Œ[nginx](http://nginx.org/ja/) â‡’ fluentd â‡’ MongoDBã€ã®è¨˜äº‹ãŒå¤šããƒ’ãƒƒãƒˆã™ã‚‹ã®ã§ã™ãŒã€ã“ã“ã¯åˆå¿ƒè€…ã£ã½ã„ã¨ã“ã‹ã‚‰å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚æ§‹æˆã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ï¼ˆ[vm ã‚’ï¼“ã¤ç”¨æ„ã—ã¦ã­](http://qiita.com/murachi1208/items/99daa3ca069d907a7b50)ï¼‰ã€‚
ã‚ã¨å…¥åŠ›ã™ã‚‹ãƒ­ã‚°ï¼ˆaa.log/bb.logï¼‰ã¯ã€å‹‰å¼·ç”¨ã®ãŸã‚ç‹¬è‡ªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¦ã¿ã¾ã—ãŸã€‚
â€»ã ã£ã¦ apache ã‚„ã‚‰ nginx ã ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã®ã§ãƒ»ãƒ»ãƒ»

![fluentd_1.png](https://qiita-image-store.s3.amazonaws.com/0/44540/8bed8d51-5a1e-7f94-2e86-d51763ce17cc.png)

## fluentd ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¯¾è±¡ã®ã‚µãƒ¼ãƒï¼ˆé€ä¿¡å´ã€å—ä¿¡å´ï¼‰ã« fluentd ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ç’°å¢ƒã«ã‚ˆã£ã¦[ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ‰‹é †](http://docs.fluentd.org/articles/install-by-rpm-v1)ã¯é•ãˆã©ã‚‚åŸºæœ¬çš„ã«ç°¡å˜ã«å°å…¥ã§ãã¾ã™ã€‚
â€»shã‚’è¦‹ã‚‹ã¨ã‚ã‹ã‚‹ã‘ã‘ã© /etc/yum.repos.d/td.repo ã«ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```text:command
$ sudo su
# curl -L http://toolbelt.treasuredata.com/sh/install-redhat.sh | sh
```

## é€ä¿¡å´ã®è¨­å®š
/tmp/aa.log ã«è¡ŒãŒè¿½åŠ ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã§ td-agent ãŒå‹•ä½œã—ã€ãƒ­ã‚°åé›†ã‚µãƒ¼ãƒã« http ã§ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ï¼ˆ/tmp/bb.log ã‚‚åŒã˜ï¼‰ã€‚

```/etc/td-agent/td-agent.conf
<source>
  type tail
  path /tmp/aa.log
  pos_file /tmp/access.pos
  format /^(?<date>[^\]]*) (?<host>[^ ]*)$/
  time_format %d/%b/%Y:%H:%M:%S
  tag test.access
</source>

<match test.access>
  type forward
  buffer_chunk_limit 256m
  buffer_queue_limit 128
  flush_interval 5s
  <server>
    host 192.168.11.106
    port 24224
  </server>
</match>
```

ã“ã“ã§ç‰¹ç­†ã™ã¹ãç‚¹ã¯ã€sourceãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ– ã® ã€Œformatã€ã§ã™ã€‚æ­£è¦è¡¨ç¾ã§æŒ‡å®šã—ã¾ã™ãŒç‰¹æ®Šãªè¨˜è¿°ã®æ–¹æ³•ãªã®ã§ç‹¬è‡ªãƒ­ã‚°ã‚’è§£æã—ã‚ˆã†ã¨æ€ã£ãŸå ´åˆã¯å°‘ã—æ‰‹é–“ãŒã‹ã‹ã‚‹ã®ã§ã€[Fluentular](http://fluentular.herokuapp.com/parse?regexp=%5E%28%3F%3Cdate%3E%5B%5E%5C%5D%5D*%29+%28%3F%3Chost%3E%5B%5E+%5D*%29&input=21%2FJun%2F2014%3A03%3A05%3A43+aaaa&time_format=%25d%2F%25b%2F%25Y%3A%25H%3A%25M%3A%25S) ã‚µã‚¤ãƒˆã§è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ä½œæˆã™ã‚‹ã®ãŒæ¥½ãƒãƒ³ã§ã™ã€‚
> [fluentdã®format(æ­£è¦è¡¨ç¾)ã®ä½œã‚Šæ–¹ã«ã¤ã„ã¦è©¦è¡ŒéŒ¯èª¤ä¸­](http://blog.glidenote.com/blog/2012/07/15/fluentd-regex-debug/)

## å—ä¿¡å´ã®è¨­å®š
ãƒ‡ãƒ¼ã‚¿ã‚’ http ã§å—ä¿¡ã— /var/log/td_log/td_access ã«çµæœã‚’å‡ºåŠ›ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```/etc/td-agent/td-agent.conf
<source>
  type forward
  port 24224
</source>

<match test.access>
  type file
  time_slice_format %Y%m%d_%H%M
  time_slice_wait 1m
  path /var/log/td_log/td_access
  time_format %Y%m%dT%H%M%S%z
</match>
```

type file ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã‚°ã‚°ã¨ä¸Šè¨˜ã®è¨­å®šã§ **td_access.log** ãŒã§ãã‚‹ãŠï¼ã¨æ›¸ã„ã¦ã‚ã‚‹ã‘ã©å®Ÿéš›ã«ã¯ã€Œ **td_access.log** + time_slice_format + _0.logã€ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
ã¾ãŸ td__access.20140622_1413.b4fc65c8fe4bf524b å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ãªã£ã¦ã—ã¾ã†ã®ã¯ã€fluentd ãŒãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã™ã‚‹å‰æ®µéšã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã‹ã‚‰ã§ã™ï¼ˆtime_slice_format ã®å½¢å¼ã§ã¾ã¨ã¾ã‚‹ã‚‰ã—ã„ï¼‰ã€‚
> [fluentdã§TimeSlicedOutputã‚’ä½¿ã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ›¸ã„ã¦ã¿ãŸ](http://erukiti.hatenablog.com/entry/20120208/1328719264)

## ãƒ†ã‚¹ãƒˆæ–¹æ³•
fluentd ãŒå‹•ä½œã—ã¦çŠ¶æ…‹ã‚’ã¿ã‚‹ã“ã¨ã«ã‚ˆã‚Šã‚¤ãƒ™ãƒ³ãƒˆã®æµã‚ŒãŒåˆ¤ã‚‹ã¨æ€ã†ã®ã§æœ€åˆã¯ã€```td-agent -vv``` ã‚³ãƒãƒ³ãƒ‰ã‚’é€å—ä¿¡å´ã§èµ·å‹•ã—ã„ãŸã»ã†ãŒã‚ˆã„ã€‚æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚èµ·å‹•ã›ãšæ­¢ã¾ã‚‹ã®ã§åŸå› ãŒè¿½ç©¶ã—ã‚„ã™ã„ã€‚

```command
$ sudo td-agent -vv
```

é€ä¿¡å´

```command
$ echo "22/Jun/2014:09:14:05 aaaa" >> /tmp/aa.log          # ãƒ­ã‚°ã¨ã—ã¦æœ‰åŠ¹ãªã“ã¨ã‚’ç¢ºèª
$ echo "22/Jun/2014:09:14:05 aaaa ddd fff" >> /tmp/aa.log  # ãƒ­ã‚°ã¨ã—ã¦ç„¡åŠ¹ãªã“ã¨ã‚’ç¢ºèª
```

# ã•ã¦é‹ç”¨ã—ã¦ã¿ã‚‹ã‹ 
å®Ÿéš›ã«ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚ **ãŒ** ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œãªã„çŠ¶æ…‹ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã—ã‹ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¦ã‚‚ [OK] ã£ã¦è¡¨ç¤ºã•ã‚Œã‚Œã¦ã„ã‚‹ãƒ»ãƒ»ãƒ»ã€‚
ãã‚“ãªã¨ãã¯ã€fluentd ã®èµ·å‹•ãƒ­ã‚° /var/log/td-agent/td-agent.log ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚ã“ã“ã«ã™ã¹ã¦ãŒæ›¸ã„ã¦ã‚ã‚‹ï½—
â€»td-agent ãƒ¦ãƒ¼ã‚¶ã§ td-agent ã‚’èµ·å‹•ã™ã‚‹ã®ã§ ã€Œ:EACCES: Permission deniedã€ã«ãªã£ã¦ã‚‹ã¨ãã‚‚ã‚ã‚‹ã€‚

```
# /etc/init.d/td-agent restart
Starting td-agent:                                         [  OK  ]
``` 

# æ¬¡ã¯
[ltsv](http://d.hatena.ne.jp/naoya/20130209/1360381374) ãƒ—ãƒ©ã‚°ãƒ³ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚’å‹‰å¼·ã—ã¦ã¿ã‚‹ï¼ˆ[ãã®ï¼’](http://qiita.com/murachi1208/items/734915c8539995bdfe39)ï¼‰ã®äºˆå®šã§ã™ï½—

## å‚è€ƒã‚µã‚¤ãƒˆ
> [td-agent(fluentd)ã®posãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã‹ãã®ä»–ã‚‚ã‚ã‚‚ã‚ã‚‚ãƒ¡ãƒ¢](http://tweeeety.hateblo.jp/entry/20131211/1386728410)
> [ã€fluentdåˆå¿ƒè€…ã€‘td-agentã«èµ·å‹•å½è£…ã•ã‚ŒãŸä»¶ã«ã¤ã„ã¦](http://qiita.com/jumbOS5/items/c7ae01f1456ef61f66a8)
> [fluentdã®ç°¡å˜ãªä½¿ã„æ–¹ã€è¨­å®šæ–¹æ³•ä¸€è¦§](http://hivecolor.com/id/37)

